<link rel="stylesheet" href="/static/css/ol.css" type="text/css">
<link rel="stylesheet" href="/static/vendor/fancybox/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen" />

<script src="/static/js/ol.js" type="text/javascript"></script>
<script src="/static/js/vendor/jquery.serializeJSON.min.js" type="text/javascript"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/openlayers/2.13.1/OpenLayers.js"></script>
<script src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.0/jquery.cookie.min.js" type="text/javascript"></script>
<script src="/static/vendor/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>
<script src="https://code.jquery.com/ui/1.8.1/jquery-ui.min.js" type="text/javascript"></script>

<style type="text/css">
	.ui-autocomplete {
		background-color: white;
		width: 300px;
		border: 1px solid #cfcfcf;
		list-style-type: none;
		padding-left: 0px;
	}
	label {
		font-size: 16px;
	}
	#map_canvas label {
		width: auto;
		display: inline;
	}
	#map_canvas img {
		max-width: none;
	}
	.affix {
		width: inherit;
		height: 0px;
	}

	.affix-bottom {
		top: auto !important;
		position: fixed;
		bottom: 240px;
	}

	#imgContainer {
		height: 390px;
		width: 600px;
	}
	#map {
		height: 400px;
		width: 100%;
	}

</style>

<div id="survey" class="modal fade" data-backdrop="static">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
					&times;
				</button>
				<h4 class="modal-title">Do you want to help us further?</h4>
			</div>
			<div class="modal-body">
				<p>
					Thank you for contributing one task for the project.
					We are interested in knowing how you found out about us.
				</p>
				<p>
					Could you please answer two questions in a short survey?
				</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					Skip
				</button>
				<a class="btn btn-large btn-success" href="https://docs.google.com/forms/d/1Foe1CCfd4K_ZmtX2W8MDsoSjjDi5zd5DLgG7yRVn2HQ/viewform?embedded=true">Of course! Take me to the survey!</a>
			</div>
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div id="survey25" class="modal fade" data-backdrop="static">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
					&times;
				</button>
				<h4 class="modal-title"> Congratulations! You have completed 25 tasks! </h4>
			</div>
			<div class="modal-body">
				<p>
					Thank you for contributing 25 tasks for the project. Now that you
					have been using MicroPasts for a while, we would like to know how
					you found it.
				</p>
				<p>
					Could you please answer a few questions in a short survey?
				</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					Skip
				</button>
				<a class="btn btn-large btn-success" href="https://docs.google.com/forms/d/1WTVapZ2Qdq0AIRazG-onDrVYDtb9xAnid7LwLrR3Uqw/viewform?embedded=true">Of course! Take me to the survey!</a>
			</div>
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div style="display:none;margin-top:15px; height:500px;" id="oldbrowser" class="row">
	<!-- Success and Error Messages for the user -->
	<div  class="col-md-8 col-md-offset-1 alert alert-info">
		<h2> Browser problems! </h2>
		<p>
			Sorry, but your browser does not support the current application.
			If you want to contribute, please, upgrade to a modern web browser
			like the open source and free alternative
			<a href="http://www.mozilla.org/en-US/firefox/new/">Firefox</a> or <a href="https://www.google.com/intl/en/chrome/browser/">Chrome</a>.
		</p>
	</div>
</div>
<!-- End of Row -->

<div style="margin-top:15px;">
	<div id="success" class="alert alert-success" style="display:none;">
		<strong>Well done!</strong> You have successfully submitted your transcription. Here is another to try if you wish!
	</div>
	<div id="loading" class="alert alert-info" style="display:none;">
		<img src="/static/img/loading.gif">Loading next task...
	</div>
	<div id="taskcompleted" class="alert alert-info" style="display:none;">
		<strong>The task has been completed!</strong> Thanks a lot!
	</div>
	<div id="finish" class="alert alert-success" style="display:none;">
		<h2> Congratulations! </h2>
		<p>
			You have participated in <strong>all</strong> available tasks! Thank you for your interest and help.
		</p>
		<br/>
		<img src="https://crowdfunded.micropasts.org/assets/logo-head.png" width="200" height="200"/>
		<div class="alert-actions">
			<a class="btn-default btn" href="/">Go back</a>
			<a class="btn-default btn" href="/app">or, Check other applications</a>
		</div>
	</div>

	<div id="error" class="alert alert-error" style="display:none;">
		<a class="close">X.</a>
		<strong>Error!</strong> Something went wrong, please contact the site
		administrators via the forum, Twitter, email or our Facebook page.
	</div>
</div>
<!-- End Success and Error Messages for the user -->

<!--
Task DOM for loading the Flickr Images
It uses the class="skeleton" to identify the elements that belong to the
task.
-->

<!-- Start Skeleton Row-->
<div class="row skeleton">

	<h1 id="start"> Please transcribe the data table(s) you see in this image </h1>

	<!-- The question will be loaded here -->

	<span class="label label-info">Note</span> You can use your mouse wheel track-pad to zoom in/out the picture, as well as drag & drop to navigate in the document.

</div>

<div class="row skeleton">

	<div id="questions" class="col-md-4">
		<!-- Start of Question and Submission DIV (column) -->

		<!-- If the user clicks this button, the saved answer will be value="yes"-->
		<form id="transcription" role="form">

			<!-- Object type form control -->
			<div class="form-group">
				<label class="control-label" for="objectType">Object Type</label>
				<input class="form-control" type="text" name="objectType" placeholder="Top of card">
			</div>
			<!-- End of object type form control -->


		</form>

		<button class="btn btn-info btn-answer" value='Yes'>
			Submit the transcription
		</button>

		<!-- Feedback items for the user -->
		<p>
			You are working now on task: <span id="task-id" class="label label-warning">#</span>
		</p>
		<p>
			You have completed: <span id="done" class="label label-info"></span> tasks from <!-- Progress bar for the user -->
			<span id="total" class="label label-inverse"></span>
		</p>
		<div class="progress progress-striped">
			<div id="progress" rel="tooltip" title="#" class="progress-bar" role="progressbar" style="width: 0%;"></div>
		</div>
		<!-- End of feedback row -->

	</div>
	<!-- End of Question and Submission DIV (column) -->

	<!-- The column holding the open layers div -->

	<div id="photo-link" class="col-md-7 col-md-offset-1">
		<!-- Start of Photo DIV (column) -->
		<div id="imgHolder" data-spy="affix" data-offset-top="1" data-offset-bottom="550">
			<div class="btn-group">
				<a class="btn btn-info btn-sm" href="#" data-toggle="modal" data-target="#myModal"><i class="glyphicon glyphicon-eye-open"></i> Tutorial</a>
				<a class="btn btn-info btn-sm" id="imgLink" target="_blank" data-toggle="tooltip" data-placement="top" title="Opens in a new window"  href="http://community.micropasts.org/category/crowdsourcing-support"><i class="glyphicon glyphicon-book"></i> Community Help</a>
				<a id="raw" href="" class="btn btn-sm btn-info fancybox" ><i class="glyphicon glyphicon-picture"></i> Overlay</a>
				<a id="flickr" rel="tooltip" target="_blank" data-toggle="tooltip" data-placement="top" title="Opens in a new window" href="" class="btn btn-sm btn-info"><i class="icon icon-flickr"></i> View on flickr</a>
				<a id="down" rel="tooltip" data-toggle="tooltip" data-placement="top" title="Only works for compliant browsers" download="" href="" class="btn btn-sm btn-info" ><i class="glyphicon glyphicon-download"></i> Download</a>
			</div>
			<!-- The container for the zoomer -->
			<div id="imgContainer"></div>
			<div id="taskImg"></div>
		</div><!-- End of Photo DIV (columnt) -->
	</div>

</div><!-- End of Skeleton Row -->

<!-- Modal start -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<!-- Modal header -->
			<div class="modal-header">
				<h3 class="lead">Asian Rice and Population Statistics Tutorial</h3>
			</div>
			<!-- stepped modal body -->
			<div id="0" class="modal-body" style="display:none">

				<p>
					This application is very simple. When you
					participate, the platform will load a scanned table of statistical
					data referring either to agricultural production or to human census
					for different regions of southern and eastern Asia during the
					1920s and 1930s. Once the image has been loaded, you will be asked
					to transcribe the contents of the table you see. Any further
					information can be placed in the top row, the bottom row or an
					extra final column (see below). An example portion of a 1921 and 1931 Indian census table is provided below.
				</p>

				<img src="http://micropasts-ricepops.s3.amazonaws.com/censusexample.png" class="img-polaroid"
				alt="An example of a census table" width="230" height="243"/>
			</div>
			<div id="1" class="modal-body" style="display:none">
				<p>
					Please do not translate anything
					(e.g. don't translate Dutch into English), just
					transcribe it,
					and retain the case of the word as it was originally
					written. When the table is first loaded, you will be prompted to define the correct number of
					total columns in the loaded table, so please check this
					carefully. We suggest that you add an extra column to
					the total number of observed columns and use it
					for passing on your own
					comments (e.g. if the observable table
					has 4 columns, stipulate 5 columns and use the
					last one for your own remarks). Please transcribe any table title or caption
					into either the top or bottom row of your spreasheet, after you have entered the table, but otherwise
					please ignore any further extraneous text on the
					scanned page (e.g. page numbers). The number of rows will expand as you type. If
					a word looks fuzzy, do you best to identify it
					and make a comment in your extra column to note
					the problem. If there happen to be two or more
					tables on the same page, then skip a line and
					continue transcribing each table.
				</p>

				<p>
					<strong>Note:</strong> If you find it easier, you can transcribe into
					an offline spreadsheet and then copy-and-paste
					the results into the online table in one go. However, bear in mind that
					a delay in submitting the online table
					might then mean that other
					contributors complete this task before you do and
					thereby make your efforts unnecessary!
				</p>

			</div>

			<!-- End of stepped modal body -->

			<!-- Modal footer -->
			<div class="modal-footer">
				<a id="prevBtn" href="#" onclick="showStep('prev')" class="btn btn-default">Previous</a>
				<a id="nextBtn" href="#" onclick="showStep('next')" class="btn btn-success">Next</a>
				<button id="startContrib" data-dismiss="modal" class="btn btn-primary" style="display:none">
					<i class="glyphicon glyphicon-thumbs-up"></i> Let's start!</a>
			</div>
		</div>
	</div>
</div>
<!-- Modal end -->
<script>
	var step = -1;
	function showStep(action) {
		$("#" + step).hide();
		if (action == 'next') {
			step = step + 1;
		}
		if (action == 'prev') {
			step = step - 1;
		}
		if (step == 0) {
			$("#prevBtn").hide();
		} else {
			$("#prevBtn").show();
		}

		if (step == 3) {
			$("#nextBtn").hide();
			$("#startContrib").show();
		}
		$("#" + step).show();
	}

	showStep('next');
	$("#modal").modal('show'); 
</script>

<!-- The modernizer script -->

<script>
	// Quick fix for IE8
	Modernizr.load({
		test : window.JSON,
		nope : '/static/js/vendor/json2.min.js'
	}); 
</script>
<!-- The main pybossa functions -->
<script>
	function loadUserProgress() {
		pybossa.userProgress('ricepops1').done(function(data) {
			console.log(data);
			console.log("Total answers done for user: " + data.done);
			if ((data.done == 1) && ($.cookie('surveyricepops1') === undefined)) {
				$("#survey").modal('show');
				$.cookie('survey', 'shown', {
					path : '/'
				});
			}
			if ((data.done == 25) && ($.cookie('survey25ricepops1') === undefined)) {
				$("#survey25").modal('show');
				$.cookie('survey25ricepops1', 'shown', {
					path : '/'
				});
			}
			var pct = Math.round((data.done * 100) / data.total);
			$("#progress").css("width", pct.toString() + "%");
			$("#progress").attr("title", pct.toString() + "% completed!");
			$("#progress").tooltip({
				'placement' : 'left'
			});
			$("#total").text(data.total);
			$("#done").text(data.done);
		});
	}
</script>

<script>
	var geocoder;
	var map;
	var marker;

	function initialize() {
		//MAP
		var latlng = new google.maps.LatLng(54, -2);
		var options = {
			zoom : 4,
			center : latlng,
			mapTypeId : google.maps.MapTypeId.TERRAIN
		};

		map = new google.maps.Map(document.getElementById("map"), options);

		//GEOCODER
		geocoder = new google.maps.Geocoder();

		marker = new google.maps.Marker({
			map : map,
			draggable : true
		});

	}


	$(document).ready(function() {

		initialize();

		$(function() {
			$("#toSearch").autocomplete({
				//This bit uses the geocoder to fetch address values
				source : function(request, response) {
					geocoder.geocode({
						'address' : request.term
					}, function(results, status) {
						response($.map(results, function(item) {
							return {
								label : item.formatted_address,
								value : item.formatted_address,
								latitude : item.geometry.location.lat(),
								longitude : item.geometry.location.lng()
							}
						}));
					})
				},
				//This bit is executed upon selection of an address
				select : function(event, ui) {
					$("#lat").val(ui.item.latitude);
					$("#lon").val(ui.item.longitude);
					var location = new google.maps.LatLng(ui.item.latitude, ui.item.longitude);
					console.log('Latitude: ' + ui.item.latitude);
					console.log('Longitude: ' + ui.item.longitude);
					marker.setPosition(location);
					map.setCenter(location);
				}
			});
		});

		//Add listener to marker for reverse geocoding
		google.maps.event.addListener(marker, 'drag', function() {
			geocoder.geocode({
				'latLng' : marker.getPosition()
			}, function(results, status) {
				if (status == google.maps.GeocoderStatus.OK) {
					if (results[0]) {
						$('#toSearch').val(results[0].formatted_address);
						$('#lat').val(marker.getPosition().lat());
						$('#lon').val(marker.getPosition().lng());
						console.log('Longitude: ' + marker.getPosition().lng());
						console.log('Latitude: ' + marker.getPosition().lat());
					}
				}
			});
		});

	}); 
</script>
<script>
	pybossa.taskLoaded(function(task, deferred) {
		if (!$.isEmptyObject(task)) {
			var img = $('<img />');
			var div_map = $('<div/>');

			div_map.css("height", "390px");
			div_map.css("width", "600px");
			div_map.css("background", "#000");

			var copyright = "&copy; <a href='" + task.info.link + "'>British Museum</a>";

			var extent = new OpenLayers.Bounds();
			extent.extend(new OpenLayers.LonLat(1.758939, 58.672231).transform(new OpenLayers.Projection("EPSG:4326"), new OpenLayers.Projection('EPSG:900913')));

			extent.extend(new OpenLayers.LonLat(-6.99745, 49.96112).transform(new OpenLayers.Projection("EPSG:4326"), new OpenLayers.Projection('EPSG:900913')));

			$("#imgContainer").append(div_map);
			div_map.attr("id", "img_" + task.id);

			task.pixelProjection = new ol.proj.Projection({
				code : 'pixel',
				units : 'pixels',
				extent : [0, 0, 1024, 720]
			});

			task.map_img = new ol.Map({
				//interactions: ol.interaction.defaults().extend([task.select, task.modify]),
				layers : [new ol.layer.Image({
					source : new ol.source.ImageStatic({
						attributions : [new ol.Attribution({
							html : copyright
						})],
						url : task.info.url_b,
						imageSize : [1024, 720],
						projection : task.pixelProjection,
						imageExtent : task.pixelProjection.getExtent()
					})
				})],
				renderer : 'canvas',
				target : 'img_' + task.id,
				view : new ol.View({
					projection : task.pixelProjection,
					center : ol.extent.getCenter(task.pixelProjection.getExtent()),
					zoom : 1.0
				})
			});
			div_map.css("display", "none");

			// load image from flickr
			var img = $('<img />');
			img.attr("id", "img_task_" + task.id);
			img.load(function() {
				// continue as soon as the image is loaded
				deferred.resolve(task);
			});
			img.attr('src', task.info.url_b);
			img.attr('width', '600px');
			img.attr('height', '390px');
			img.addClass('img-polaroid');
			img.css("cursor", "zoom-in");
			task.info.image = img;

		} else {
			deferred.resolve(task);
		}

	}); 
</script>
<script>
	pybossa.presentTask(function(task, deferred) {
		if (!$.isEmptyObject(task)) {
			loadUserProgress();
			$(':input', '#transcription').not(':button, :submit, :reset, :hidden, :radio').val('').removeAttr('checked').removeAttr('selected');

			$("a#raw").attr("href", task.info.url_b);
			$("a#flickr").attr("href", task.info.link + '/sizes/k/');
			$("a#down").attr("download", task.id);
			$("a#down").attr("href", task.info.url_b);
			$(".fancybox").fancybox();
			$('#imgLink').tooltip();
			$("[rel=tooltip]").tooltip();
			$("#searchingTip").hide();
			$("#question").html(task.info.question);
			$('#task-id').html(task.id);
			$("#map_" + task.id).show();
			$("#img_" + task.id).show();

			// Clean
			$('select[name=dateDiscoveryYear]').html('').append($('<option/>').val('None').html('Year'));
			for ( i = 1700; i < 2000; i++) {
				$('select[name=dateDiscoveryYear]').append($('<option />').val(i).html(i));
			}

			$('select[name=dateDiscoveryMonth]').html('').append($('<option/>').val('None').html('Month'));
			for ( i = 1; i <= 12; i++) {
				$('select[name=dateDiscoveryMonth]').append($('<option />').val(i).html(i));
			}

			$('select[name=dateDiscoveryDay]').html('').append($('<option/>').val('None').html('Day'));
			for ( i = 1; i <= 31; i++) {
				$('select[name=dateDiscoveryDay]').append($('<option />').val(i).html(i));
			}

			$('.btn-answer').off('click').on('click', function(evt) {
				evt.preventDefault();
				var answer = $(evt.target).attr("value");
				if ( typeof answer !== 'undefined') {
					console.log(answer);
					if (answer === 'search') {
						$("#searching").show();
						search(task, $("#toSearch").val(), 15);
					} else {
						task.answer = $("#transcription").serializeJSON();
						console.log(task.answer);
						if ($('#lon').val()) {
							var geojson = {
								"geometry" : {
									"type" : "Point",
									"coordinates" : [$('#lon').val(), $('#lat').val()]
								},
								"crs" : {
									"type" : "name",
									"properties" : {
										"name" : "urn:ogc:def:crs:OGC:1.3:CRS84"
									}
								},
								"type" : "Feature",
								"properties" : {

								}
							};
							console.log(geojson);
							task.answer.geojson = geojson;
						}
						task.answer.toSearch = task.answer.toSearch.replace(/\n/g, ', ');
						task.answer.site = task.answer.site.replace(/\r\n/g, ', ');
						console.log(task.answer);

						pybossa.saveTask(task.id, task.answer).done(function() {
							$("#map_" + task.id).hide();
							$("#img_" + task.id).hide();
							//$('#img_task_' + task.id).trigger('wheelzoom.reset');
							$("html, body").animate({
								scrollTop : 0
							}, "slow");
							$("#success").fadeIn(500).fadeOut(5500);
							$("#loading").fadeIn(500).fadeOut(1000);
							deferred.resolve();
						});
						$("#loading").fadeIn(500);

					}
				} else {
					console.log(answer);
					console.log( typeof (answer));
					$("#error").show();
				}
			});
			$("#loading").hide();
		} else {
			$(".skeleton").hide();
			$("#loading").hide();
			$("#finish").fadeIn(500);
		}
	});

	if (Modernizr.borderradius) {
		pybossa.run('ricepops1');
	} else {
		$(".skeleton").hide();
		$("#oldbrowser").show();
	}
	$(window).off('.affix');
	$("#imgHolder").removeClass("affix affix-top affix-bottom").removeData("bs.affix"); 
</script>
